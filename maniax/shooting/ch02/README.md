## 탄환
- 탄환의 움직임을 프로그래밍하는 데 있어서 기본이 되는 것은 '조준탄(메인 케릭터 방향으로 날아오는 탄환)'과 방향탄(임의의 방향으로 날아가는 탄환'의 2종류이다. 복잡해보이는 탄막도 대부분 이 2가지 탄환을 조합하여 만들 수 있다.

### 2.1 조준탄
#### 탄환의 속도
- 적기의 좌표:(ex, ey)
- 메인 케릭터의 좌표:(mx, my)
- 탄환은 적기에 출발해서 5초 뒤에 메인 케릭터에 닿는다면
```c++
탄환의 좌표:(vx, vy) = (mx - ey) / 5, (mx - ey) / 5;
즉, vx = (mx - ex) / n, vy = (my - ey) / n;
```
- 이러한 방식의 문제점
	- 적기와 메인 케릭터의 위치에 따라 탄환의 속도가 변하는 문제가 있다. (적기와 메인 케릭터가 멀리 있음-> 탄환의 속도가 빨라짐, 가까이 있음-> 탄환이 느려짐)
	- 수학적으로, 탄환의 속도 벡터 (vx, vy)의 길이를 일정한 값으로 정으로 정해야 한다.
```c++
d = sqrt((mx - ex) * (mx - ex) + (my - ey) * (my - ey));
cf. sqrt는 C에 math.h, C++에 cmath에 정의되어 있다.
```

#### 거리가 0일 때의 탄환의 속도 계산
- 탄환의 속도를 구할 때 거리로 나눗셈을 하였으나 거리가 0이 되는 경우에는 속도를 구할 수 없다. 거리가 0이 되는 것은 적기와 메인 케릭터가 겹쳐 있는 상황이다. 적기와 메인 케릭터가 충돌했을 때 메인 케릭터가 즉시 파괴되는 게임이라면 상관이 없지만, 조금씩 피해를 입는 게임이라면 처리 방법을 고려해야봐야 한다.
1. 탄환을 발사하지 않음
2. 아래쪽위나 위쪽 등, 정해진 방향으로 탄환 발사
3. 임의의 방향을 탄환 발사

### 2.2 DDA를 사용하여 탄환을 이동시키기
- 성능이 떨어지는 환경이거나 휴대전화용 J2ME(java)환경에서는 실수형을 사용하지 않도록 해야 한다.
- DDA(Digital Differenctial Analyzer, 디지털 미분 해석기)란 컴퓨터 그래픽스에서 직선을 그릴 때 사용하는 방법이다. 정수 연산만을 이용해서 실제 직선에 가장 가까운 화소를 재빨리 구하는 알고리즘이다.
	- X방향과 Y방향 중 모교물 위치와 차이값이 큰 쪽은 매번 이동시킴.
	- 차이 값이 작은 쪽은 오차가 누적되었을 때만 이동시킴.
	- 수평이나 수직 방향일 때는 정확히 speed의 속도로 이동하지만 비스듬히 날아갈 때는 speeed보다 조금 빨라진다. 45도의 각도로 날아갈 때 가장 빠르며, 이때 약 1.4배의 속도가 된다.(1/sin45도)
### 2.3 고정소수점수를 사용하여 탄환을 이동시키기
- 고정소수점수를 사용한 덧셈
	- 0.37 + 3.94 = 4.31
	- 37 + 394 = 431
- 고정소수점수를 사용한 곱셈
	- 0.37 * 3.94 = 1.4578
	- 37 * 394 / 100 = 145
- 고정소수점수를 사용한 나눗셈
	- 0.37 / 3.94 = 0.0939
	- 37 * 100 / 394 = 9
#### 시프트 연산과 고정소수점수
- 시프트를 할 때는 정수형의 하위 비트를 소수 부분에 할당하게 된다. (일반적인 int형은 32비트의 폭을 가지는데 여기서 하위 8비트나 하위 16비트를 소수 부분에 할당한다)
- int형의 경우 32비트 모두 정수 부분으로 표현할 때 -21억~21억까지 표현할 수 있지만 하위 8비트를 소수 부분으로 사용하면 정수 부분은 -8,388,608 ~ 8,388,607까지 밖에 표현할 수 없다.
```c++
a + b
a - b

a * b >> 8 // 하위 8비트를 소수 부분으로 정했을 경우
(a << 8) / b
a << 8
a >> 8
```
#### 고정소수점수를 사용하여 탄환을 이동시키기
```c++
d = sqrt((mx - ex) * (mx - ex) + (my - ey) * (my - ey))
vx = (mx - ex) / d * speed
vy = (my - ey) / d * speed
// 고정소수점수를 사용할 경우 
vx = (mx - ex) * speed / d
vy = (my - ey) * speed / d //가급적 계산 오류를 줄이기 위해 나눗셈을 가장 마지막에 실행한다.
```
- 표준 C라이브러리의 sqrt함수는 실수형을 가지고 처리한다.
	- 제곱근 등을 사용하여 고정소수점수 연산만으로 평방근을 구하는 sqrt함수를 직접 만든다
	- X축과 Y축의 거리 중 보다 큰 쪽을 골라서 실제 거리 대신 쓴다.
- 고정소수점수 연산을 사용하면 탄환의 속도가 바뀌지 않기 때문에 실수형을 사용할 때와 거의 같은 결과를 얻는다. 단, 만드는 과정에서 고정 소수점수가 번거롭다. 최신 PC에서 작업한다면 실수형을 써도 무방하다.

### 2.4 방향탄
```c++
// speed의 속도로 각소 theta 방햐으로 날아가는 탄환의 속도 벡터(vx, vy)를 구하기
vs = cos(M_PI / 180 * theta) * speed; // M_PI는 원주율
vy = sin(M_PI / 180 * theta) * speed; 
```
### 2.5 테이블을 이용한 방향탄
- 테이블 이용하는 방법의 이점은 단순함에 있다. 문제는 탄환이 발사하는 방향이 8, 16방향으로 제한되는 점과 방향에 따라 미묘하게 탄환의 속도가 달라지는 점, 속도 벡터의 테이블을 별도로 준비해야 한다는 점이 있다. 또한, 세세한 탄막을 만들어내기 어렵다. 

### 2.6 DDA를 사용한 방향탄
- '탄환의 주위를 여러대의 메인 케릭터가 원형으로 둘러싼 상태'를 상상해보면 알 수 있듯이, 쏘고자 하는 방향에 있는 가상의 메인 케릭터를 향해 조준탄을 쏘면 그것이 바로 방향탄이 된다.
- 이때 중요한 점은 탄환의 시작 위치에서 어느정도 먼 곳에 메인 케릭터를 배치해야 한다. 멀리 배침으로써 탄환을 보내는 방향의 정확도가 향상되기 때문이다.
```c++
int mx = cos(M_PI / 180 * theta) * 1000;
int my = sin(M_PI / 180 * theta) * 1000;
```

#### 정수형만 가지고 처리하기
```c++
cos(rad) * 1000;
sin(rad) * 1000;

void make_table()
{
	for (int idx = 0; idx < 360; ++idx)
	{
		m_pos[idx][0] = cos(M_PI / 180 * idx) * 1000;
		m_pos[idx][1] = sin(M_PI / 180 * idx) * 1000;
	}
}

// 가상의 메인 케릭터의 위치를 테이블에서 읽어옴
int dir = (theta % 360 + 360) % 360;
int mx = m_pos[dir][0];
int my = m_pos[dir][1];
```

### 2.7 탄환을 제거하기
```
// 화면 테두리의 좌상좌표 (sx0, sy0), 우하좌표(sx1, sy1)
// 탄환의 좌상좌표(x0, y0), 우하좌표(x1, y1)
// 탄환이 완전히 화면 밖으로 빠져나갈 조건
(x0 >= sx1 || x1 <= sx0 || y0 >= sy1 || y1 <= sy0) // y축 좌표가 이해가 안되는데,,
// 탄환이 완전히 화면 안에 있을 조건
(sx0 <= sx0 && x1 <= sx1 && sy0 <= y0 && y1 <= sy1)
// 탄환의 일부가 화면 안에 있을 조건
sx0 < x1 && x0 < sx1 && sy0 < y1 && y0 < sy1
!(x1 <= sx0 || sx1 <= x0 || y1 <= sy0 || sy1 <= y0)
```
- 탄환을 제거할 때 사용하는 화면 테두리는 실제 화면 테두리보다 조금 넓게 잡아줄 것.
(곧 화면으로 들어올 탄환은 제거하지 않고, 화면 밖으로 나간 탄환은 제거함)

### 2.8 탄환의 충돌 판정
- 가장 일반적인 것은 좌표를 사용하여 판정하는 방법
```c++
// 탄환의 좌상좌표(x0, y0), 우하좌표(x1, y1)
// 메인 케릭터 좌상좌표(mx0, my0), 우하좌표(mx1, my1)
// 탄환이 메인 케릭터에 맞았을 조건
(mx0 < x1 && mx1 > x0 && my0 < y1 && my1 > y0)
!(x1 <= mx0 || mx1 <= x0 || y1 <= my0 || my1 <= y0)
```

#### 충돌 판정 역역의 설정
- 탄환이나 메인 케릭터의 실제 크기보다 조금 작게, 즉 탄환이나 메인 케릭터의 중심부에 설정한다.

### 2.9 n_way탄
- n-way 탄은 방향탄을 응용해서 만들 수 있다. 중심선을 향해 날아가는 탄환을 기준으로 좌우로 적당한 각도를 주어가며 탄환을 발사하면 된다. (홀수 패턴, 짝수 패턴 번갈아 발사하면 메인케릭터가 쉴새없이 움직여야 하므로 게임성이 좋아지게 된다)
- 
