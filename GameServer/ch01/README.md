## ch01. 멀티스레딩
### 1-1 프로그램과 프로세스
- 프로그램이란 컴퓨터에서 실행되는 명령어 모음이 들어 있는 데이터 덩어리를 의미한다. 크게 코드(code)와 데이터(data)로 구성되어 있다.
- 프로세스(process)란 프로그램을 실행하면 프로그램 안에 들어 있는 명령어가 한 줄씩 실행되면서 프로그램은 뭔가 활동을 하는 상태가 되는 것을 말한다.
- 프로그램에 있는 코드와 데이터는 이 프로세스 메모리로 불러들인다. 프로세스 메모리에는 프로그램 코드와 데이터는 물론, 힙(heap)과 스택(stack)도 공존한다.
- 프로그램은 디스크 같은 저장소에 있고, 프로세스는 RAM 메모리에 있다.
- 프로세스가 여러 개 실행되고 있는 것을 멀티프로세싱(multi-processing)이라고 한다.
### 1-2 스레드
- 각 프로세스는 독립된 메모리 공간이 있다. 기본적으로 서로 다른 프로세스는 상대방의 메모리 공간을 읽고 쓸 수 없다.
- 대부분의 운영체제는 스레드(thread)라는 기능을 제공한다. 스레드 역시 프로세스처럼 명령어를 한 줄씩 실행하는 기본 단위이다.
- 즉, 프로그램이 실행되는 기본 단위는 스레드이다.
```c++
프로그램을 실행하면 프로세스가 생성된다. 프로세스 안에는 유일한 스레드가 있고 그 안에서 프로그램이 실행된다.
```
- 동시에 하나만 실행되는 프로그램을 싱글스레드 프로그램이라고 한다. 이렇게 설계하고 구현한 것을 싱글스레드 모델(single threaded model)이라고 한다.
- 프로그램이 싱글 스레드로 작동하는 동안, 프로세스 안에서 여러 스레드를 생성시킬 수 있다. 그리고 이런 여러 스레드는 동시에 실행된다. 여러 스레드가 동시에 여러 가지 일을 처리하게 하는 것을 멀티스레드 모델 혹은 멀티스레딩이라고 한다.
#### 스레드와 프로세스의 차이점
1. 스레드는 한 프로세스 안에 여러개가 있다.
2. 한 프로세스 안에 있는 스레드는 프로세스 안에 있는 메모리 공간을 같이 사용할 수 있다.
3. 스레드마다 스택을 가진다. 각 스레드에서 실행되는 함수의 로컬 변수들이 스레드마다 있다는 것을 의미한다.
- C언어에서는 운영체제마다 스레드 생성하는 함수가 다르다. 하지만, ㅊ++에서는 통일되었다.
```c++
std::thread t1(ThreadProc, 123);
```
### 1.3 멀티스레드 프로그래밍은 언제 해야 할까?
- 멀티스레드 프로그래밍은 똑같은 연산을 하더라도 연산 속도고 훨씬 더 느려지기도 하고, 조금만 실수해도 심각한 오류가능성이 있다.
- 멀티스레드 프로그래밍을 해야하는 대표적인 상황
1. 오래 걸리는 일 하나와 빨리 끝나는 일 여럿을 같이 해야 할 때
2. 어떤 긴 처리를 진행하는 동안 다른 짧은 일을 처리해야 할 때
3. 기기에 있는 CPU를 모두 활용해야 할 때

#### 첫번째 상황
- (게임을 켜고 게임 스테이지 안에 들어가기 전에, 게임 프로그램은 케릭터와 배경을 구성하는 그래픽 리소스를 로딩하기 위해 많은 양의 데이터를 디스크에서 읽어와야 한다.)
- 멀티스레딩을 하지 않는다면 로딩하는 동안 다른 뭔가를 하도록 구현해준다. (코드가 지저분해지고, 로딩하는 파일이 크다면 일시적으로 프레임률이 뚝뚝 끊길 것이다)
```c++
bool isStillLoading;

Thread1
{
	isStillLoading = true;
	while (isStillLoading)
	{
		// 게임 루프를 돌면서 지속적으로 렌더링을 수행한다.
		FrameMove();
		Render();
	}
}
Thread2
{
	LoadScene();
	LoadModel();
	...
}
```

#### 두번째 상황
- 플레이어 정보를 읽거나 쓰려고 디스크를 엑세스하는 경우이다. 디스크를 엑세스하는 스레드는 디스크의 처리 결과가 끝날 때까지 기다려야 하는데, 이 시간동안 CPU는 놀게 된다. 
- 플레이어 정보를 디스크에 기록하는 시간은 1만분의 1초 정도이지만, 상용 게임 서버입장에서는 엄청난 시간 낭비가 될 수 있다.
- CPU 속도는 크게 증가하지 않았다. 서버가 8코어 CPU를 장착했는데, 싱글스레드로 게임 서버를 만든다면 서버는 전체 연산 성능의 1/8만 사용하는 꼴이다.

### 1.4 스레드 정체
- CPU는 하나인데 어떻게 여러 프로그램이 동시에 실행될 수 있을까요? 여러 프로세스나 여러 스레드가 동시에 실행될 수 있을까요?
- 여러 프로세스와 여러 스레드를 동시에 실행해야 하는 운영체제는 이렇게 여러 프로세스와 각 프로세스 안에 스레드들을 일정 시간마다 번갈아 가면서 실행한다. 각 스레드를 실행하다 말고 다른 스레드를 마저 실행하는 과정을 컨텍스트 스위치(context switch)라고 한다.
```c++
컨텍스트 스위치를 하는 과정에서 적지 않은 양의 연산이 발생한다. 우선 실행 중이던 스레드의 상태(호출 스택)를 어딘가에 저장하고, 과거에 실행하다가 만 다른 스레드 중에서 하나를 고른다. 고른 스레드의 상태(호출 스택 등)을 복원하고, 그런 다음 실행지점으로 강제 이동한다.
============================================================
컨텍스트 스위치를 자주 할수록 성능이 안좋아진다고 하니, 최대한 덜하는 방향을 생각해보자.
ex) 로딩 중에 애니메이션을 뿌리는 경우를 생각.
컨텍스트 스위치가 어떤 스레드를 일시 정지하고 다시 컨텍스트 스위치로 실행을 마저하는데 1초라면, 로딩 중에 애니메이션은 1초에 한번 밖에 실행되지 못한다. 사람이 보는 입장에선 답답하게 보일 것이다.
사람 입장에서 쾌적할 수 있는 시간 단위를 타임 슬라이스(time slice)라고 한다. 보통 스레드 하나가 일시 정지했다 다시 시작하는데까지 걸리는 시간은 약 5밀리초이다. 컴퓨터 입장에서 초당 5억개를 처리할 수 있는 CPU라면 5억 * 5밀리초 = 250만개의 명령어를 처리할 수 있는 시간이다.
=============================================================
CPU 개수와 스레드 개수가 같거나 스레드 개수가 더 적으면 컨텍스트 스위치가 발생할 이유가 없다. 하지만 스레드 개수가 더 많으면 이는 발생한다. 단, Runnable 상태의 스레드가 CPU개수보다 많을 경우 성능문제가 될 뿐이다. waitable 상태의 스레드는 이러한 성능문제가 없다.
=============================================================
c나 c++로 프로그래밍을 하는 경우, 한 구문은 실제로 기계어 명령 여러개로 컴파일 된다. <컨텍스트 스위치>는 기계어 명령어 단위로 일어난다. 따라서 소스의 한 줄 구문 안에 있는 것을 실행하다 말고 컨텍스트 스위치를 할 가능성이 있는 것이다.
```
```c++
b = a * 2;
이를 기계어로 실행한다면,
1. ...
2. r1 = a //r은 레지스터, a는 메모리공간
3. r2 = r1 * 2
4. b = r2
5. ...

4번을 실행한 후 5를 실행하기 전에 무족건 컨텍스트 스위치가 실행된다면, 이 C언어 구문은 항상 정확한 결과가 나온다. 그러나 불행히도 우리는 컴퓨터가 1~5 중 어디까지 실행한 후 컨텍스트를 스위치를 일으킬지 예상할 수가 없다.
```
